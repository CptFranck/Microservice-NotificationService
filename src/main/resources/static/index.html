<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booking Notification Client</title>

    <!-- âœ… Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@22.0.3/dist/keycloak.min.js"></script>
    <!--    &lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/keycloak-js@21.1.0/dist/keycloak.min.js"></script>&ndash;&gt;-->
    <!--    &lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/keycloak-js@26.2.1/lib/keycloak.min.js"></script>&ndash;&gt;-->

    <!-- âœ… Bootstrap JS (for components, no jQuery needed) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… Optional Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

</head>
<body class="bg-light">
<div class="container py-5">
    <!-- SECTION: Keycloak -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="card-title mb-3">ğŸ” Keycloak - JavaScript Integration</h2>
            <p class="text-muted">A pure JavaScript web app demonstrating Keycloak integration.</p>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <button onclick="login()" class="btn btn-primary">Login</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
                <button onclick="isLogged()" class="btn btn-info text-white">Is Logged In</button>
                <button onclick="accessToken()" class="btn btn-warning">Access Token</button>
                <button onclick="showToken()" class="btn btn-dark">Show Parsed Token</button>
            </div>

            <label for="output">Output :</label>
            <textarea id="output" class="form-control" rows="5" placeholder="Output will be displayed here..."></textarea>
        </div>
    </div>

    <!-- SECTION: Booking -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="card-title mb-4">ğŸŸï¸ Booking Client Demo</h2>

            <form class="row g-3">
                <div class="col-md-4">
                    <label for="userId" class="form-label">User ID</label>
                    <input type="number" id="userId" class="form-control" value="1">
                </div>
                <div class="col-md-4">
                    <label for="eventId" class="form-label">Event ID</label>
                    <input type="number" id="eventId" class="form-control" value="1">
                </div>
                <div class="col-md-4">
                    <label for="ticketCount" class="form-label">Tickets</label>
                    <input type="number" id="ticketCount" class="form-control" value="100">
                </div>
            </form>

            <div class="mt-4 d-flex flex-wrap gap-2">
                <button id="toggleModeBtn" onclick="toggleWebSocketMode()" class="btn btn-danger" type="button">
                    <i class="bi bi-arrow-repeat me-1"></i>
                    Mode actuel : <span id="modeLabel">WebSocket direct</span>
                </button>
                <button onclick="connectWebSocket()" class="btn btn-primary">
                    <i class="bi bi-plug"></i> Connect WebSocket
                </button>
                <button onclick="createBooking()" class="btn btn-success">
                    <i class="bi bi-ticket-perforated"></i> Create Booking
                </button>
            </div>
        </div>
    </div>

    <!-- SECTION: Messages -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h3 class="card-title mb-3">ğŸ“¡ Received Events</h3>
            <ul id="eventList" class="list-group"></ul>
        </div>
    </div>
</div>

<script>

    const keycloak = new Keycloak({
        url: "http://localhost:8091",
        realm: "ticketing-security-realm",
        clientId: "ticketing-client-id",
    });

    const outputTextarea = document.getElementById('output');;
    initKeycloak()

    function logToTextarea(message) {
        const now = new Date();
        const timestamp = now.toLocaleString();
        outputTextarea.value += `[${timestamp}] ${message}\n`;
    }

    function initKeycloak() {
        keycloak.init({
            onLoad: 'check-sso',
            redirectUri: window.location.href
            // checkLoginIframe: false,
        }).then(authenticated => {
            logToTextarea(authenticated ? 'User is authenticated' : 'User is not authenticated');
            if (authenticated) console.log("âœ… Authenticated:", keycloak.token);
            else console.warn("âŒ Not authenticated");
        }).catch(err => {
            console.error('Erreur Keycloak', err);
        });
    }

    function login(){
        logToTextarea('Login button clicked');
        keycloak.login();
    }
    function logout(){
        logToTextarea('Logout button clicked');
        keycloak.logout();
    }

    function isLogged(){
        const isLoggedInMessage = keycloak.authenticated ? 'User is logged in' : 'User is not logged in';
        logToTextarea('Is Logged In button clicked: ' + isLoggedInMessage);
        alert(isLoggedInMessage);
    }

    function accessToken(){
        if (keycloak.authenticated) {
            logToTextarea('Access Token button clicked: ' + keycloak.token);
            alert('Access Token: ' + keycloak.token);
        } else {
            const notLoggedInMessage = 'User is not logged in';
            logToTextarea('Access Token button clicked: ' + notLoggedInMessage);
            alert(notLoggedInMessage);
        }
    }

    function showToken(){
        if (keycloak.authenticated) {
            const parsedToken = keycloak.tokenParsed;
            logToTextarea('Show Parsed Access Token button clicked: ' + JSON.stringify(parsedToken, null, 2));
            alert('Parsed Access Token: ' + JSON.stringify(parsedToken, null, 2));
        } else {
            const notLoggedInMessage = 'User is not logged in';
            logToTextarea('Show Parsed Access Token button clicked: ' + notLoggedInMessage);
            alert(notLoggedInMessage);
        }
    }

        // http://localhost:8091/realms/ticketing-security-realm/protocol/openid-connect/token
        //         // setInterval(() => {
        //         //     keycloak.updateToken(60).then(refreshed => {
        //         //         if (refreshed) console.log("ğŸ”„ Token refreshed");
        //         //     }).catch(() => {
        //         //         console.warn("âŒ Token refresh failed, logging out");
        //         //         keycloak.logout();
        //         //     });
        //         // }, 30000);

    let token = null;
    let userId = null;
    let useGateway = false;

    const modeLabel = document.getElementById("modeLabel");
    const toggleBtn = document.getElementById("toggleModeBtn");

    function toggleWebSocketMode(){
        useGateway = !useGateway;
        if (useGateway) {
            modeLabel.textContent = "API Gateway";
            toggleBtn.classList.remove("btn-danger");
            toggleBtn.classList.add("btn-success");
        } else {
            modeLabel.textContent = "WebSocket direct";
            toggleBtn.classList.remove("btn-success");
            toggleBtn.classList.add("btn-danger");
        }
    }

    let socket = null

    function connectWebSocket() {
        userId = document.getElementById("userId").value;
        if(useGateway)
            socket = new SockJS("http://localhost:8090/ws-notification");
        else
            socket = new SockJS("http://localhost:8085/ws-notification");
        stompClient = Stomp.over(socket);

        stompClient.connect({
            Authorization: `Bearer ${token}`
        },
            () => {
            console.log("âœ… Connected as user", userId);

            stompClient.subscribe(`/user/${userId}/bookings`, (message) => {
                const event = JSON.parse(message.body);
                console.log("ğŸ“¨ Booking event received:", event);
                showEvent(event);
            });
        },
            (error) => {
            console.error("âŒ STOMP connection error:", error);
        });
    }

    function createBooking() {
        const booking = {
            userId: Number(document.getElementById("userId").value),
            eventId: Number(document.getElementById("eventId").value),
            ticketCount: Number(document.getElementById("ticketCount").value)
        };

        fetch("http://localhost:8081/api/v1/booking", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(booking)
        })
            .then(res => res.json())
            .then(data => {
                console.log("ğŸ« Booking created:", data);
            })
            .catch(err => console.error("âŒ Error creating booking:", err));
    }

    function showEvent(event) {
        const li = document.createElement("li");
        let text = "";

        if (event.totalPrice !== undefined) {
            text = `âœ… Booking confirmed for Event ${event.eventId} - Tickets: ${event.ticketCount} - Total: $${event.totalPrice}`;
        } else if (event.reason !== undefined) {
            text = `âŒ Booking rejected for Event ${event.eventId} - Tickets: ${event.ticketCount} - Reason: ${event.reason}`;
        } else {
            text = `ğŸ« Booking updated for Event ${event.eventId} - Tickets: ${event.ticketCount}`;
        }

        li.textContent = text;
        document.getElementById("eventList").appendChild(li);
    }
</script>
</body>
</html>
