<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booking Notification Client</title>

    <!-- ‚úÖ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@22.0.3/dist/keycloak.min.js"></script>
    <!--    &lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/keycloak-js@21.1.0/dist/keycloak.min.js"></script>&ndash;&gt;-->
    <!--    &lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/keycloak-js@26.2.1/lib/keycloak.min.js"></script>&ndash;&gt;-->

    <!-- ‚úÖ Bootstrap JS (for components, no jQuery needed) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ Optional Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

</head>
<body class="bg-light">
<div class="container py-5">
    <!-- SECTION: Keycloak -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="card-title mb-3">üîê Keycloak - JavaScript Integration</h2>
            <p class="text-muted">A pure JavaScript web app demonstrating Keycloak integration.</p>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <button onclick="login()" class="btn btn-primary">Login</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
                <button onclick="isLogged()" class="btn btn-info text-white">Is Logged In</button>
                <button onclick="accessToken()" class="btn btn-warning">Access Token</button>
                <button onclick="showToken()" class="btn btn-dark">Show Parsed Token</button>
                <a href="http://localhost:8091/realms/ticketing-security-realm/account" class="btn btn-dark">
                    Account
                </a>
                <a href="https://localhost:8091/realms/ticketing-security-realm/account/security/signingin" target="_blank">
                    Changer mon mot de passe
                </a>
            </div>

            <label for="output">Output </label>
            <textarea id="output" class="form-control" rows="2" placeholder="Output will be displayed here..."></textarea>
        </div>
    </div>

    <!-- Bouton simple de connexion -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h5 class="card-title mb-3">üîó Connection Control</h5>

            <div class="d-flex flex-wrap gap-2 align-items-center">
                <button id="toggleModeBtn" onclick="toggleApiGateWayUse()" class="btn btn-danger" type="button">
                    <i class="bi bi-arrow-repeat me-1"></i>
                    Mode actuel : <span id="modeLabel">WebSocket direct</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SECTION: Inventory GET Test -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="card-title mb-4">üì¶ Inventory API Test</h2>

            <div class="mb-3">
                <label for="venueId" class="form-label">Venue ID</label>
                <input type="number" id="venueId" class="form-control" value="1">
            </div>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <button onclick="inventoryByVenueId()" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat me-1"></i> Get Inventory By Venue Id
                </button>
                <button onclick="clearInventoryServiceApiOutput()" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i> Clear
                </button>
            </div>

            <div class="mb-3">
                <label class="form-label">Response</label>
                <pre id="inventoryApiOutput" class="form-control" style="height:auto; min-height:50px; overflow:auto;"></pre>
            </div>
        </div>
    </div>

    <!-- SECTION: Booking POST TEST -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <h2 class="card-title mb-4">üéüÔ∏è Booking Client Demo</h2>

            <form class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">User ID</label>
                    <pre id="keycloakUserId" class="form-control" style="height:auto; min-height:50px; overflow:auto;"></pre>
                </div>
                <div class="col-md-4">
                    <label for="eventId" class="form-label">Event ID</label>
                    <input type="number" id="eventId" class="form-control" value="1">
                </div>
                <div class="col-md-4">
                    <label for="ticketCount" class="form-label">Tickets</label>
                    <input type="number" id="ticketCount" class="form-control" value="100">
                </div>
            </form>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <button onclick="createBooking()" class="btn btn-primary">
                    <i class="bi bi-ticket-perforated"></i> Create Booking
                </button>
                <button onclick="clearBookingServiceApiOutput()" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i> Clear
                </button>
            </div>
            <div class="mb-3">
                <label class="form-label">Response</label>
                <pre id="bookingApiOutput" class="form-control" style="height:auto; min-height:50px; overflow:auto;"></pre>
            </div>
        </div>
    </div>

    <!-- SECTION: Messages -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h3 class="card-title mb-3">üì° Received Events</h3>
            <div class="mb-3">
                <button onclick="connectWebSocket()" class="btn btn-primary">
                    <i class="bi bi-plug"></i> Connect WebSocket
                </button>
            </div>
            <div class="mb-3">
                <ul id="eventList" class="list-group"></ul>
            </div>

        </div>
    </div>
</div>

<script>

    const keycloak = new Keycloak({
        url: "http://localhost:8091",
        realm: "ticketing-security-realm",
        clientId: "ticketing-client-id",
    });

    const outputTextarea = document.getElementById('output');
    const keycloakUserIdOutput = document.getElementById('keycloakUserId');

    initKeycloak()

    function logToTextarea(message) {
        const now = new Date();
        const timestamp = now.toLocaleString();
        outputTextarea.value += `[${timestamp}] ${message}\n`;
    }

    function initKeycloak() {
        keycloak.init({
            onLoad: 'check-sso',
            redirectUri: window.location.href
            // checkLoginIframe: false,
        }).then(authenticated => {
            logToTextarea(authenticated ? 'User is authenticated' : 'User is not authenticated');
            if (authenticated) console.log("‚úÖ Authenticated:", keycloak.tokenParsed);
            console.log(keycloak)
            keycloakUserIdOutput.textContent  = keycloak.idTokenParsed.sid
        }).catch(err => {
            console.error('Erreur Keycloak', err);
        });
    }

    function login(){
        logToTextarea('Login button clicked');
        keycloak.login();
    }
    function logout(){
        logToTextarea('Logout button clicked');
        keycloak.logout();
    }

    function isLogged(){
        const isLoggedInMessage = keycloak.authenticated ? 'User is logged in' : 'User is not logged in';
        logToTextarea('Is Logged In button clicked: ' + isLoggedInMessage);
        alert(isLoggedInMessage);
    }

    function accessToken(){
        if (keycloak.authenticated) {
            logToTextarea('Access Token button clicked: ' + keycloak.token);
            alert('Access Token: ' + keycloak.token);
        } else {
            const notLoggedInMessage = 'User is not logged in';
            logToTextarea('Access Token button clicked: ' + notLoggedInMessage);
            alert(notLoggedInMessage);
        }
    }

    function showToken(){
        if (keycloak.authenticated) {
            const parsedToken = keycloak.tokenParsed;
            logToTextarea('Show Parsed Access Token button clicked: ' + JSON.stringify(parsedToken, null, 2));
            alert('Parsed Access Token: ' + JSON.stringify(parsedToken, null, 2));
        } else {
            const notLoggedInMessage = 'User is not logged in';
            logToTextarea('Show Parsed Access Token button clicked: ' + notLoggedInMessage);
            alert(notLoggedInMessage);
        }
    }

        // http://localhost:8091/realms/ticketing-security-realm/protocol/openid-connect/token
        //         // setInterval(() => {
        //         //     keycloak.updateToken(60).then(refreshed => {
        //         //         if (refreshed) console.log("üîÑ Token refreshed");
        //         //     }).catch(() => {
        //         //         console.warn("‚ùå Token refresh failed, logging out");
        //         //         keycloak.logout();
        //         //     });
        //         // }, 30000);

    let address = null;
    let useGateway = true;

    const modeLabel = document.getElementById("modeLabel");
    const toggleBtn = document.getElementById("toggleModeBtn");

    if (useGateway) {
        modeLabel.textContent = "API Gateway";
        toggleBtn.classList.remove("btn-danger");
        toggleBtn.classList.add("btn-success");
    } else {
        modeLabel.textContent = "WebSocket direct";
        toggleBtn.classList.remove("btn-success");
        toggleBtn.classList.add("btn-danger");
    }

    const API_GATEWAY = 'http://localhost:8090';
    const API_BOOKING_SERVICE = 'http://localhost:8081';
    const API_INVENTORY_SERVICE = 'http://localhost:8080';
    const API_NOTIFICATION_SERVICE = 'http://localhost:8085';

    function toggleApiGateWayUse(){
        useGateway = !useGateway;
        if (useGateway) {
            modeLabel.textContent = "API Gateway";
            toggleBtn.classList.remove("btn-danger");
            toggleBtn.classList.add("btn-success");
        } else {
            modeLabel.textContent = "WebSocket direct";
            toggleBtn.classList.remove("btn-success");
            toggleBtn.classList.add("btn-danger");
        }
    }

    const inventoryServiceOutput = document.getElementById('inventoryApiOutput');

    function inventoryByVenueId() {
        const venueId = document.getElementById('venueId').value || 1;

        if(useGateway) address = API_GATEWAY;
        else address = API_INVENTORY_SERVICE;

        const url = `${address}/api/v1/inventory/venue/${venueId}`;
        logToTextarea(`üîç Calling: ${url}`)
        fetch(url, {
            method: "GET",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + keycloak.token,
            }
        })
            .then(res => res.json())
            .then(data => inventoryServiceOutput.textContent  = `‚úÖ Response:\n${JSON.stringify(data, null, 2)}\n`)
            .catch(err => inventoryServiceOutput.textContent  = `üö® Error: ${err.message}\n`);
    }

    function clearInventoryServiceApiOutput(){
        inventoryServiceOutput.textContent = '';
    }

    const bookingServiceOutput = document.getElementById('bookingApiOutput');

    function createBooking() {
        const booking = {
            userId: Number(document.getElementById("userId").value),
            eventId: Number(document.getElementById("eventId").value),
            ticketCount: Number(document.getElementById("ticketCount").value)
        };

        if(useGateway) address = API_GATEWAY;
        else address = API_BOOKING_SERVICE;

        fetch(`${address}/api/v1/booking`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + keycloak.token,
            },
            body: JSON.stringify(booking)
        })
            .then(res => res.json())
            .then(data => bookingServiceOutput.textContent  = `‚úÖ Response:\n${JSON.stringify(data, null, 2)}\n`)
            .catch(err => bookingServiceOutput.textContent  = `üö® Error: ${err.message}\n`);
    }

    function clearBookingServiceApiOutput(){
        bookingServiceOutput.textContent = '';
    }


    function connectWebSocket() {
        const userId = document.getElementById("userId").value;

        if(useGateway) address = API_GATEWAY;
        else address = API_NOTIFICATION_SERVICE;

        const socket = new SockJS(`${address}/ws-notification/`, null, { transports: ['websocket'] });
        const stompClient = Stomp.over(socket);

        stompClient.connect({
                Authorization: `Bearer ${keycloak.token}`
            },
            () => {
                console.log("‚úÖ Connected as user", userId);
                stompClient.subscribe(`/user/${userId}/bookings`, (message) => {
                    const event = JSON.parse(message.body);
                    console.log("üì® Booking event received:", event);
                    showEvent(event);
                });
            },
            (error) => {
                console.error("‚ùå STOMP connection error:", error);
            });
    }

    function showEvent(event) {
        const li = document.createElement("li");
        let text = "";

        if (event.totalPrice !== undefined) {
            text = `‚úÖ Booking confirmed for Event ${event.eventId} - Tickets: ${event.ticketCount} - Total: $${event.totalPrice}`;
        } else if (event.reason !== undefined) {
            text = `‚ùå Booking rejected for Event ${event.eventId} - Tickets: ${event.ticketCount} - Reason: ${event.reason}`;
        } else {
            text = `üé´ Booking updated for Event ${event.eventId} - Tickets: ${event.ticketCount}`;
        }

        li.textContent = text;
        document.getElementById("eventList").appendChild(li);
    }
</script>
</body>
</html>
